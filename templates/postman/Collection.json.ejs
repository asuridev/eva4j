<%
// Helper function to generate example ID based on type
function getExampleId() {
  const idExamples = {
    'String': '123',
    'Long': '123',
    'Integer': '123',
    'UUID': '550e8400-e29b-41d4-a716-446655440000'
  };
  return idExamples[idType] || '1';
}

// Apply validation-aware overrides to a base dummy value
function applyValidationOverrides(field, baseValue) {
  const annotations = field.validationAnnotations || [];
  if (annotations.length === 0) return baseValue;

  let value = baseValue;

  for (const ann of annotations) {
    if (/@Email/i.test(ann)) {
      value = 'user@example.com';
      break;
    }
    if (/@Future/i.test(ann)) {
      value = '2027-01-01T10:00:00';
      break;
    }
    if (/@Past/i.test(ann)) {
      value = '2020-01-01T10:00:00';
      break;
    }
    if (/@PositiveOrZero/i.test(ann)) {
      value = typeof baseValue === 'string' ? '0.00' : 0;
      break;
    }
    if (/@Positive/i.test(ann)) {
      value = typeof baseValue === 'string' ? '1.00' : 1;
      break;
    }
    const minMatch = ann.match(/@Min\s*\(\s*(?:value\s*=\s*)?(\d+)/);
    if (minMatch) {
      const min = parseInt(minMatch[1], 10);
      value = typeof baseValue === 'string' ? String(min) : min;
      break;
    }
    const maxMatch = ann.match(/@Max\s*\(\s*(?:value\s*=\s*)?(\d+)/);
    if (maxMatch) {
      const max = parseInt(maxMatch[1], 10);
      value = typeof baseValue === 'string' ? String(max) : max;
      break;
    }
    const sizeMatch = ann.match(/@Size\s*\(.*?min\s*=\s*(\d+)/);
    if (sizeMatch) {
      const min = parseInt(sizeMatch[1], 10);
      value = 'a'.repeat(Math.max(min, 1));
      break;
    }
    if (/@NotBlank|@NotEmpty/i.test(ann) && (value === null || value === '')) {
      value = `example_${field.name}`;
      break;
    }
    const patternMatch = ann.match(/@Pattern\s*\(.*?regexp\s*=\s*"([^"]+)"/);
    if (patternMatch) {
      const re = patternMatch[1];
      if (/^\^\[0-9\]|^\^\\d/.test(re)) value = '12345';
      else if (/^\^\[A-Z\]/.test(re)) value = 'Example';
      break;
    }
  }

  return value;
}

// Generate dummy value based on field type
function generateDummyValue(field, depth = 0) {
  const MAX_DEPTH = 3;
  
  if (depth >= MAX_DEPTH) return null;
  
  // Handle basic types
  const basicTypes = {
    'String': `Example ${field.name}`,
    'Integer': 123,
    'Long': 123456789,
    'Double': 99.99,
    'BigDecimal': '99.99',
    'Boolean': true,
    'LocalDate': '2026-02-03',
    'LocalDateTime': '2026-02-03T10:30:00',
    'LocalTime': '10:30:00',
    'UUID': '550e8400-e29b-41d4-a716-446655440000'
  };
  
  if (basicTypes[field.javaType] !== undefined) {
    return applyValidationOverrides(field, basicTypes[field.javaType]);
  }
  
  // Handle enums — search allEnums (covers root + secondary entity enums)
  if (field.isEnum) {
    const enumDef = allEnums.find(e => e.name === field.javaType);
    if (enumDef && enumDef.values && enumDef.values.length > 0) {
      return enumDef.values[0];
    }
    return 'EXAMPLE_VALUE';
  }
  
  // Handle value objects (nested objects)
  if (field.isValueObject) {
    const voName = field.javaType.toLowerCase();
    if (voName.includes('money') || voName.includes('price') || voName.includes('amount')) {
      return { amount: '99.99', currency: 'USD' };
    }
    if (voName.includes('address')) {
      return { street: '123 Main St', city: 'New York', state: 'NY', zipCode: '10001', country: 'USA' };
    }
    if (voName.includes('email')) {
      return { value: 'example@email.com' };
    }
    if (voName.includes('phone')) {
      return { value: '+1-555-0123' };
    }
    return { value: `example_${field.name}` };
  }
  
  // Handle collections
  if (field.isCollection) {
    return [`example_item_1`, `example_item_2`];
  }
  
  return applyValidationOverrides(field, `example_${field.name}`);
}

// Generate nested relationship object
function generateNestedObject(rel, depth = 0) {
  const MAX_DEPTH = 3;
  
  if (depth >= MAX_DEPTH) return null;
  
  const obj = {};
  
  // Add fields (exclude readOnly and id — server-generated)
  if (rel.fields && rel.fields.length > 0) {
    rel.fields.filter(f => !f.readOnly && f.name !== 'id').forEach(field => {
      obj[field.name] = generateDummyValue(field, depth + 1);
    });
  }
  
  // Add nested OneToMany relationships recursively
  if (rel.hasNestedRelationships && rel.nestedRelationships) {
    rel.nestedRelationships.forEach(nestedRel => {
      const nestedObj = generateNestedObject(nestedRel, depth + 1);
      if (nestedObj) {
        obj[nestedRel.fieldName] = [nestedObj];
      }
    });
  }

  // Add forward OneToOne sub-entities (flattened as single object, not array)
  if (rel.nestedOneToOneRelationships && rel.nestedOneToOneRelationships.length > 0) {
    rel.nestedOneToOneRelationships.forEach(otoRel => {
      const otoObj = {};
      (otoRel.fields || []).filter(f => !f.readOnly && f.name !== 'id').forEach(field => {
        otoObj[field.name] = generateDummyValue(field, depth + 1);
      });
      obj[otoRel.fieldName] = otoObj;
    });
  }
  
  return obj;
}

// Helper function to generate complete create body
function generateCreateBody() {
  const body = {};
  
  // Add regular fields (readOnly and id already excluded via commandFields)
  commandFields.forEach(field => {
    body[field.name] = generateDummyValue(field);
  });
  
  // Add nested relationships
  if (oneToManyRelationships && oneToManyRelationships.length > 0) {
    oneToManyRelationships.forEach(rel => {
      const nestedObj = generateNestedObject(rel, 0);
      if (nestedObj) {
        body[rel.fieldName] = [nestedObj];
      }
    });
  }
  
  return body;
}
%>
{
  "info": {
    "_postman_id": "<%= collectionId %>",
    "name": "<%= aggregateName %> API",
    "description": "Auto-generated CRUD API for <%= aggregateName %> aggregate\nModule: <%= moduleName %>\nGenerated by eva4j",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "version": "1.0.0"
  },
  "item": [
    {
      "name": "Create <%= aggregateName %>",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }<% if (trackUser) { %>,
          {
            "key": "X-User",
            "value": "system"
          }<% } %>
        ],
        "url": {
          "raw": "http://localhost:<%= port %>/api/<%= apiVersion %>/<%= resourceNameKebab %>",
          "protocol": "http",
          "host": ["localhost"],
          "port": "<%= port %>",
          "path": ["api", "<%= apiVersion %>", "<%= resourceNameKebab %>"]
        },
        "body": {
          "mode": "raw",
          "raw": <%- JSON.stringify(JSON.stringify(generateCreateBody(), null, 2)) %>,
          "options": {
            "raw": {
              "language": "json"
            }
          }
        }
      },
      "response": []
    },
    {
      "name": "Get <%= aggregateName %> by ID",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:<%= port %>/api/<%= apiVersion %>/<%= resourceNameKebab %>/<%= getExampleId() %>",
          "protocol": "http",
          "host": ["localhost"],
          "port": "<%= port %>",
          "path": ["api", "<%= apiVersion %>", "<%= resourceNameKebab %>", "<%= getExampleId() %>"]
        }
      },
      "response": []
    },
    {
      "name": "Get All <%= aggregateName %>s",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "http://localhost:<%= port %>/api/<%= apiVersion %>/<%= resourceNameKebab %>",
          "protocol": "http",
          "host": ["localhost"],
          "port": "<%= port %>",
          "path": ["api", "<%= apiVersion %>", "<%= resourceNameKebab %>"]
        }
      },
      "response": []
    },
    {
      "name": "Delete <%= aggregateName %>",
      "request": {
        "method": "DELETE",
        "header": [<% if (trackUser) { %>{ "key": "X-User", "value": "system" }<% } %>],
        "url": {
          "raw": "http://localhost:<%= port %>/api/<%= apiVersion %>/<%= resourceNameKebab %>/<%= getExampleId() %>",
          "protocol": "http",
          "host": ["localhost"],
          "port": "<%= port %>",
          "path": ["api", "<%= apiVersion %>", "<%= resourceNameKebab %>", "<%= getExampleId() %>"]
        }
      },
      "response": []
    }
  ]
}
