package <%= packageName %>.<%= moduleName %>.application.mappers;

import <%= packageName %>.<%= moduleName %>.application.commands.Create<%= aggregateName %>Command;
import <%= packageName %>.<%= moduleName %>.application.dtos.<%= aggregateName %>ResponseDto;
<% secondaryEntities.forEach(entity => { %>
import <%= packageName %>.<%= moduleName %>.application.dtos.Create<%= entity.name %>Dto;
import <%= packageName %>.<%= moduleName %>.application.dtos.<%= entity.name %>Dto;
<% }); %>
import <%= packageName %>.<%= moduleName %>.domain.models.entities.<%= aggregateName %>;
<% secondaryEntities.forEach(entity => { %>
import <%= packageName %>.<%= moduleName %>.domain.models.entities.<%= entity.name %>;
<% }); %>
<% if (validatedVos && validatedVos.length > 0) { %>
<% validatedVos.forEach(vo => { %>
import <%= packageName %>.<%= moduleName %>.application.dtos.Create<%= vo.name %>Dto;
import <%= packageName %>.<%= moduleName %>.domain.models.valueObjects.<%= vo.name %>;
<% }); %>
<% } %>
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * <%= aggregateName %>ApplicationMapper
 * Maps between commands, DTOs and domain entities
 */
@Component
public class <%= aggregateName %>ApplicationMapper {

    // ========== Command to Domain Mapping ==========
    
    /**
     * Convert Create<%= aggregateName %>Command to <%= aggregateName %> domain entity
     */
    public <%= aggregateName %> fromCommand(Create<%= aggregateName %>Command command) {
        if (command == null) return null;
        
        <%= aggregateName %> entity = new <%= aggregateName %>(
<% if (commandFields) { %>
<% commandFields.forEach((field, idx) => { %>
            <% if (field.originalVoType) { %>to<%= field.originalVoType %>(command.<%= field.name %>())<% } else { %>command.<%= field.name %>()<% } %><% if (idx < commandFields.length - 1) { %>,<% } %>
<% }); %>
<% } %>
        );
        
<% if (oneToManyRelationships && oneToManyRelationships.length > 0) { %>
<% oneToManyRelationships.forEach(rel => { %>
        // Map <%= rel.fieldName %> collection
        if (command.<%= rel.fieldName %>() != null) {
            command.<%= rel.fieldName %>().forEach(itemDto -> {
  <% if (!rel.hasNestedRelationships && !(rel.nestedOneToOneRelationships && rel.nestedOneToOneRelationships.length > 0)) { %>
                // Direct call to factory method with parameters
                entity.add<%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
                    <% if (field.originalVoType) { %>to<%= field.originalVoType %>(itemDto.<%= field.name %>())<% } else { %>itemDto.<%= field.name %>()<% } %><%= idx < rel.fields.length - 1 ? ',' : '' %>
<% }); %>
                );
  <% } else if (!rel.hasNestedRelationships && rel.nestedOneToOneRelationships && rel.nestedOneToOneRelationships.length > 0) { %>
                // Flattened factory call (DDD: aggregate root controls all sub-entity creation)
                entity.add<%= rel.targetEntityName %>(
<% rel.fields.forEach(field => { %>
                    <% if (field.originalVoType) { %>to<%= field.originalVoType %>(itemDto.<%= field.name %>())<% } else { %>itemDto.<%= field.name %>()<% } %>,
<% }); %>
<% rel.nestedOneToOneRelationships.forEach((otoRel, otoIdx) => { %>
<% otoRel.fields.forEach((field, fIdx) => { %>
<% const isLastParam = otoIdx === rel.nestedOneToOneRelationships.length - 1 && fIdx === otoRel.fields.length - 1; %>
                    itemDto.<%= otoRel.fieldName %>() != null ? <% if (field.originalVoType) { %>to<%= field.originalVoType %>(itemDto.<%= otoRel.fieldName %>().<%= field.name %>())<% } else { %>itemDto.<%= otoRel.fieldName %>().<%= field.name %>()<% } %> : null<%= isLastParam ? '' : ',' %>
<% }); %>
<% }); %>
                );
  <% } else { %>
                // Complex nested collections â€” use helper method
                <%= rel.targetEntityName %> item = fromDto<%= rel.targetEntityName %>(itemDto);
                if (item != null) {
                    entity.add<%= rel.targetEntityName %>(item);
                }
  <% } %>
            });
        }
        
<% }); %>
<% } %>
<% if (oneToOneRelationships && oneToOneRelationships.length > 0) { %>
<% oneToOneRelationships.forEach(rel => { %>
        // Map <%= rel.fieldName %> OneToOne relationship
        if (command.<%= rel.fieldName %>() != null) {
            // Call factory method with parameters
            entity.assign<%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
                <% if (field.originalVoType) { %>to<%= field.originalVoType %>(command.<%= rel.fieldName %>().<%= field.name %>())<% } else { %>command.<%= rel.fieldName %>().<%= field.name %>()<% } %><%= idx < rel.fields.length - 1 ? ',' : '' %>
<% }); %>
            );
        }
        
<% }); %>
<% } %>
        return entity;
    }
<% if (oneToManyRelationships && oneToManyRelationships.length > 0) { %>
<% oneToManyRelationships.forEach(rel => { %>
    
    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     * Public for use by CommandHandler when needed
     */
    public <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;
        
        <%= rel.targetEntityName %> entity = new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            <% if (field.originalVoType) { %>to<%= field.originalVoType %>(dto.<%= field.name %>())<% } else { %>dto.<%= field.name %>()<% } %><% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
<% if (rel.hasNestedRelationships && rel.nestedRelationships) { %>
<% rel.nestedRelationships.forEach(nestedRel => { %>
        
        // Map nested <%= nestedRel.fieldName %> collection
        if (dto.<%= nestedRel.fieldName %>() != null) {
            dto.<%= nestedRel.fieldName %>().forEach(nestedDto -> {
                <%= nestedRel.targetEntityName %> nestedItem = fromDto<%= nestedRel.targetEntityName %>(nestedDto);
                if (nestedItem != null) {
                    entity.add<%= nestedRel.targetEntityName %>(nestedItem);
                }
            });
        }
<% }); %>
<% } %>
<% if (rel.nestedOneToOneRelationships && rel.nestedOneToOneRelationships.length > 0) { %>
<% rel.nestedOneToOneRelationships.forEach(otoRel => { %>
        
        // Map nested OneToOne <%= otoRel.fieldName %>
        if (dto.<%= otoRel.fieldName %>() != null) {
            entity.assign<%= otoRel.fieldName.charAt(0).toUpperCase() + otoRel.fieldName.slice(1) %>(fromDto<%= otoRel.targetEntityName %>(dto.<%= otoRel.fieldName %>()));
        }
<% }); %>
<% } %>
        
        return entity;
    }
<% }); %>
<% } %>
<%
// Collect all nested (grandchild) entities that need their own fromDto* method.
// A grandchild fromDto* is needed when a direct child has nestedRelationships.
const generatedFromDtoNames = new Set(
  (oneToManyRelationships || []).map(r => r.targetEntityName)
);
const grandchildRels = [];
(oneToManyRelationships || []).forEach(rel => {
  if (rel.hasNestedRelationships && rel.nestedRelationships) {
    rel.nestedRelationships.forEach(nested => {
      if (!generatedFromDtoNames.has(nested.targetEntityName)) {
        generatedFromDtoNames.add(nested.targetEntityName);
        grandchildRels.push(nested);
      }
    });
  }
});
%>
<% grandchildRels.forEach(rel => { %>

    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     * Generated for nested (grandchild) entity
     */
    public <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;

        <%= rel.targetEntityName %> entity = new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            <% if (field.originalVoType) { %>to<%= field.originalVoType %>(dto.<%= field.name %>())<% } else { %>dto.<%= field.name %>()<% } %><% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
<% if (rel.hasNestedRelationships && rel.nestedRelationships) { %>
<% rel.nestedRelationships.forEach(nestedRel => { %>
        if (dto.<%= nestedRel.fieldName %>() != null) {
            dto.<%= nestedRel.fieldName %>().forEach(nestedDto -> {
                <%= nestedRel.targetEntityName %> nestedItem = fromDto<%= nestedRel.targetEntityName %>(nestedDto);
                if (nestedItem != null) {
                    entity.add<%= nestedRel.targetEntityName %>(nestedItem);
                }
            });
        }
<% }); %>
<% } %>
        return entity;
    }
<% }); %>
<%
// Collect all unique nestedOneToOneRelationships targets that haven't had fromDto generated yet
const nestedOtoNames = new Set([
  ...Array.from(generatedFromDtoNames)
]);
const nestedOneToOneTargets = [];
(oneToManyRelationships || []).forEach(rel => {
  (rel.nestedOneToOneRelationships || []).forEach(otoRel => {
    if (!nestedOtoNames.has(otoRel.targetEntityName)) {
      nestedOtoNames.add(otoRel.targetEntityName);
      nestedOneToOneTargets.push(otoRel);
    }
  });
});
%>
<% nestedOneToOneTargets.forEach(rel => { %>

    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     * Generated for nested OneToOne sub-entity
     */
    public <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;

        return new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            <% if (field.originalVoType) { %>to<%= field.originalVoType %>(dto.<%= field.name %>())<% } else { %>dto.<%= field.name %>()<% } %><% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
    }
<% }); %>
<% if (oneToOneRelationships && oneToOneRelationships.length > 0) { %>
<% oneToOneRelationships.forEach(rel => { %>
    
    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     * Public for use by CommandHandler when needed
     */
    public <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;
        
        <%= rel.targetEntityName %> entity = new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            <% if (field.originalVoType) { %>to<%= field.originalVoType %>(dto.<%= field.name %>())<% } else { %>dto.<%= field.name %>()<% } %><% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
        
        return entity;
    }
<% }); %>
<% } %>
<% if (validatedVos && validatedVos.length > 0) { %>

    // ========== Value Object Conversion Helpers ==========
<% validatedVos.forEach(vo => { %>
    public <%= vo.name %> to<%= vo.name %>(Create<%= vo.name %>Dto dto) {
        if (dto == null) return null;
        return new <%= vo.name %>(<% vo.fields.forEach((f, idx) => { %>dto.<%= f.name %>()<%= idx < vo.fields.length - 1 ? ', ' : '' %><% }); %>);
    }
<% }); %>
<% } %>

    // ========== Domain to Response DTO Mapping ==========

    /**
     * Map <%= aggregateName %> aggregate to <%= aggregateName %>ResponseDto
     */
    public <%= aggregateName %>ResponseDto toDto(<%= aggregateName %> entity) {
        if (entity == null) {
            return null;
        }
        
        return new <%= aggregateName %>ResponseDto(
<% responseFields.forEach((field, idx) => { %>
            entity.get<%= field.name.charAt(0).toUpperCase() + field.name.slice(1) %>()<% if (idx < responseFields.length - 1 || rootEntity.relationships.filter(r => (r.type === 'OneToMany' || r.type === 'OneToOne') && !r.isInverse).length > 0) { %>,<% } %>
<% }); %>
<% rootEntity.relationships.filter(r => (r.type === 'OneToMany' || r.type === 'OneToOne') && !r.isInverse).forEach((rel, idx, arr) => { %>
  <% if (rel.type === 'OneToMany') { %>
            entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>() != null ?
                entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>().stream()
                    .map(this::to<%= rel.target %>Dto)
                    .collect(Collectors.toList()) : null<% if (idx < arr.length - 1) { %>,<% } %>
  <% } else if (rel.type === 'OneToOne') { %>
            to<%= rel.target %>Dto(entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>())<% if (idx < arr.length - 1) { %>,<% } %>
  <% } %>
<% }); %>
        );
    }
    
    /**
     * Map List of <%= aggregateName %> to List of <%= aggregateName %>ResponseDto
     */
    public List<<%= aggregateName %>ResponseDto> toDto(List<<%= aggregateName %>> entities) {
        if (entities == null) {
            return new ArrayList<>();
        }
        return entities.stream()
            .map(entity -> toDto(entity))
            .collect(Collectors.toList());
    }
    
<% responseSecondaryEntities.forEach(entity => { %>
<% const entityNestedRels = (entity.nestedRelationships || []).filter(r => !r.isInverse); %>
<% const entityForwardOtoRels = (entity.forwardOneToOneRels || []); %>
    /**
     * Map <%= entity.name %> to <%= entity.name %>Dto
     */
    private <%= entity.name %>Dto to<%= entity.name %>Dto(<%= entity.name %> domainEntity) {
        if (domainEntity == null) {
            return null;
        }
        
        return new <%= entity.name %>Dto(
<% entity.responseFields.forEach((field, idx) => { %>
            domainEntity.get<%= field.name.charAt(0).toUpperCase() + field.name.slice(1) %>()<% if (idx < entity.responseFields.length - 1 || entityNestedRels.length > 0 || entityForwardOtoRels.length > 0) { %>,<% } %>
<% }); %>
<% entityNestedRels.forEach((rel, idx) => { %>
  <% if (rel.type === 'OneToMany') { %>
            domainEntity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>() != null ?
                domainEntity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>().stream()
                    .map(item -> to<%= rel.targetEntityName %>Dto(item))
                    .collect(Collectors.toList()) : null<% if (idx < entityNestedRels.length - 1 || entityForwardOtoRels.length > 0) { %>,<% } %>
  <% } else if (rel.type === 'OneToOne') { %>
            to<%= rel.targetEntityName %>Dto(domainEntity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>())<% if (idx < entityNestedRels.length - 1 || entityForwardOtoRels.length > 0) { %>,<% } %>
  <% } %>
<% }); %>
<% entityForwardOtoRels.forEach((rel, idx) => { %>
            to<%= rel.targetEntityName %>Dto(domainEntity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>())<% if (idx < entityForwardOtoRels.length - 1) { %>,<% } %>
<% }); %>
        );
    }
    
<% }); %>
}
