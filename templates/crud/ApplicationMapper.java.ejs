package <%= packageName %>.<%= moduleName %>.application.mappers;

import <%= packageName %>.<%= moduleName %>.application.commands.Create<%= aggregateName %>Command;
import <%= packageName %>.<%= moduleName %>.application.dtos.<%= aggregateName %>ResponseDto;
<% secondaryEntities.forEach(entity => { %>
import <%= packageName %>.<%= moduleName %>.application.dtos.Create<%= entity.name %>Dto;
import <%= packageName %>.<%= moduleName %>.application.dtos.<%= entity.name %>Dto;
<% }); %>
import <%= packageName %>.<%= moduleName %>.domain.models.entities.<%= aggregateName %>;
<% secondaryEntities.forEach(entity => { %>
import <%= packageName %>.<%= moduleName %>.domain.models.entities.<%= entity.name %>;
<% }); %>
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * <%= aggregateName %>ApplicationMapper
 * Maps between commands, DTOs and domain entities
 */
@Component
public class <%= aggregateName %>ApplicationMapper {

    // ========== Command to Domain Mapping ==========
    
    /**
     * Convert Create<%= aggregateName %>Command to <%= aggregateName %> domain entity
     */
    public <%= aggregateName %> fromCommand(Create<%= aggregateName %>Command command) {
        if (command == null) return null;
        
        <%= aggregateName %> entity = new <%= aggregateName %>(
<% if (commandFields) { %>
<% commandFields.forEach((field, idx) => { %>
            command.<%= field.name %>()<% if (idx < commandFields.length - 1) { %>,<% } %>
<% }); %>
<% } %>
        );
        
<% if (oneToManyRelationships && oneToManyRelationships.length > 0) { %>
<% oneToManyRelationships.forEach(rel => { %>
        // Map <%= rel.fieldName %> collection
        if (command.<%= rel.fieldName %>() != null) {
            command.<%= rel.fieldName %>().forEach(itemDto -> {
                <%= rel.targetEntityName %> item = fromDto<%= rel.targetEntityName %>(itemDto);
                if (item != null) {
                    entity.add<%= rel.targetEntityName %>(item);
                }
            });
        }
        
<% }); %>
<% } %>
<% if (oneToOneRelationships && oneToOneRelationships.length > 0) { %>
<% oneToOneRelationships.forEach(rel => { %>
        // Map <%= rel.fieldName %> OneToOne relationship
        if (command.<%= rel.fieldName %>() != null) {
            <%= rel.targetEntityName %> item = fromDto<%= rel.targetEntityName %>(command.<%= rel.fieldName %>());
            entity.assign<%= rel.targetEntityName %>(item);
        }
        
<% }); %>
<% } %>
        return entity;
    }
<% if (oneToManyRelationships && oneToManyRelationships.length > 0) { %>
<% oneToManyRelationships.forEach(rel => { %>
    
    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     */
    private <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;
        
        <%= rel.targetEntityName %> entity = new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            dto.<%= field.name %>()<% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
<% if (rel.hasNestedRelationships && rel.nestedRelationships) { %>
<% rel.nestedRelationships.forEach(nestedRel => { %>
        
        // Map nested <%= nestedRel.fieldName %> collection
        if (dto.<%= nestedRel.fieldName %>() != null) {
            dto.<%= nestedRel.fieldName %>().forEach(nestedDto -> {
                <%= nestedRel.targetEntityName %> nestedItem = fromDto<%= nestedRel.targetEntityName %>(nestedDto);
                if (nestedItem != null) {
                    entity.add<%= nestedRel.targetEntityName %>(nestedItem);
                }
            });
        }
<% }); %>
<% } %>
        
        return entity;
    }
<% }); %>
<% } %>
<% if (oneToOneRelationships && oneToOneRelationships.length > 0) { %>
<% oneToOneRelationships.forEach(rel => { %>
    
    /**
     * Convert Create<%= rel.targetEntityName %>Dto to <%= rel.targetEntityName %> domain entity
     */
    private <%= rel.targetEntityName %> fromDto<%= rel.targetEntityName %>(Create<%= rel.targetEntityName %>Dto dto) {
        if (dto == null) return null;
        
        <%= rel.targetEntityName %> entity = new <%= rel.targetEntityName %>(
<% rel.fields.forEach((field, idx) => { %>
            dto.<%= field.name %>()<% if (idx < rel.fields.length - 1) { %>,<% } %>
<% }); %>
        );
        
        return entity;
    }
<% }); %>
<% } %>

    // ========== Domain to Response DTO Mapping ==========

    /**
     * Map <%= aggregateName %> aggregate to <%= aggregateName %>ResponseDto
     */
    public <%= aggregateName %>ResponseDto toDto(<%= aggregateName %> entity) {
        if (entity == null) {
            return null;
        }
        
        return new <%= aggregateName %>ResponseDto(
<% responseFields.forEach((field, idx) => { %>
            entity.get<%= field.name.charAt(0).toUpperCase() + field.name.slice(1) %>()<% if (idx < responseFields.length - 1 || rootEntity.relationships.filter(r => (r.type === 'OneToMany' || r.type === 'OneToOne') && !r.isInverse).length > 0) { %>,<% } %>
<% }); %>
<% rootEntity.relationships.filter(r => (r.type === 'OneToMany' || r.type === 'OneToOne') && !r.isInverse).forEach((rel, idx, arr) => { %>
  <% if (rel.type === 'OneToMany') { %>
            entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>() != null ?
                entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>().stream()
                    .map(this::to<%= rel.target %>Dto)
                    .collect(Collectors.toList()) : null<% if (idx < arr.length - 1) { %>,<% } %>
  <% } else if (rel.type === 'OneToOne') { %>
            to<%= rel.target %>Dto(entity.get<%= rel.fieldName.charAt(0).toUpperCase() + rel.fieldName.slice(1) %>())<% if (idx < arr.length - 1) { %>,<% } %>
  <% } %>
<% }); %>
        );
    }
    
    /**
     * Map List of <%= aggregateName %> to List of <%= aggregateName %>ResponseDto
     */
    public List<<%= aggregateName %>ResponseDto> toDto(List<<%= aggregateName %>> entities) {
        if (entities == null) {
            return new ArrayList<>();
        }
        return entities.stream()
            .map(this::toDto)
            .collect(Collectors.toList());
    }
    
<% responseSecondaryEntities.forEach(entity => { %>
    /**
     * Map <%= entity.name %> to <%= entity.name %>Dto
     */
    private <%= entity.name %>Dto to<%= entity.name %>Dto(<%= entity.name %> domainEntity) {
        if (domainEntity == null) {
            return null;
        }
        
        return new <%= entity.name %>Dto(
<% entity.responseFields.forEach((field, idx) => { %>
            domainEntity.get<%= field.name.charAt(0).toUpperCase() + field.name.slice(1) %>()<% if (idx < entity.responseFields.length - 1) { %>,<% } %>
<% }); %>
        );
    }
    
<% }); %>
}
